package com.csd.repointel.model;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

/**
 * Model representing a complete vulnerability report for a repository.
 */
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class RepoVulnerabilityReport {
    private String repoName;
    private String repoUrl;
    private LocalDateTime scanDate;
    private List<DependencyVulnerability> vulnerabilities;
    private VulnerabilityStatistics statistics;
    private double riskScore;               // 0-100, weighted by severity
    private int healthScore;                // 0-100, overall repo health
    private String riskLevel;               // "Critical", "High", "Medium", "Low", "Safe"
    private List<String> recommendations;
    private boolean fixAvailable;

    /**
     * Get count of vulnerable dependencies.
     */
    public int getVulnerableCount() {
        if (vulnerabilities == null) return 0;
        return (int) vulnerabilities.stream()
                .filter(DependencyVulnerability::isVulnerable)
                .count();
    }

    /**
     * Get count of outdated dependencies.
     */
    public int getOutdatedCount() {
        if (vulnerabilities == null) return 0;
        return (int) vulnerabilities.stream()
                .filter(DependencyVulnerability::isOutdated)
                .count();
    }

    /**
     * Get count of safe dependencies.
     */
    public int getSafeCount() {
        if (vulnerabilities == null) return 0;
        return (int) vulnerabilities.stream()
                .filter(v -> v.getStatus() == VulnerabilityStatus.SAFE)
                .count();
    }

    /**
     * Get all critical vulnerabilities.
     */
    public List<DependencyVulnerability> getCriticalVulnerabilities() {
        if (vulnerabilities == null) return new ArrayList<>();
        return vulnerabilities.stream()
                .filter(v -> v.getSeverity() == VulnerabilitySeverity.CRITICAL)
                .toList();
    }

    /**
     * Get all high severity vulnerabilities.
     */
    public List<DependencyVulnerability> getHighVulnerabilities() {
        if (vulnerabilities == null) return new ArrayList<>();
        return vulnerabilities.stream()
                .filter(v -> v.getSeverity() == VulnerabilitySeverity.HIGH)
                .toList();
    }
}
