package com.csd.repointel.service;

import com.csd.repointel.model.*;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.extern.slf4j.Slf4j;
import org.apache.poi.ss.usermodel.*;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;
import org.springframework.stereotype.Service;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.time.format.DateTimeFormatter;
import java.util.List;

/**
 * Service for exporting vulnerability reports in various formats
 */
@Service
@Slf4j
public class VulnerabilityExportService {

    private final ObjectMapper objectMapper;
    private static final DateTimeFormatter DATE_FORMATTER = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");

    public VulnerabilityExportService(ObjectMapper objectMapper) {
        this.objectMapper = objectMapper;
    }

    /**
     * Export vulnerability reports as CSV
     */
    public byte[] exportCsv(List<RepoVulnerabilityReport> reports) throws IOException {
        log.info("Exporting {} vulnerability reports as CSV", reports.size());

        StringBuilder csv = new StringBuilder();
        
        // Header
        csv.append("Repository,Package,Group ID,Artifact ID,Current Version,Status,CVE ID,Severity,CVSS Score,Recommended Version,Description\n");

        // Data rows
        for (RepoVulnerabilityReport report : reports) {
            for (DependencyVulnerability vuln : report.getVulnerabilities()) {
                csv.append(String.format("\"%s\",\"%s\",\"%s\",\"%s\",\"%s\",\"%s\",\"%s\",\"%s\",%.1f,\"%s\",\"%s\"\n",
                        escapeCsv(report.getRepoName()),
                        escapeCsv(vuln.getGroupId() + ":" + vuln.getArtifactId()),
                        escapeCsv(vuln.getGroupId()),
                        escapeCsv(vuln.getArtifactId()),
                        escapeCsv(vuln.getCurrentVersion()),
                        vuln.getStatus().getDisplayName(),
                        escapeCsv(vuln.getCveId() != null ? vuln.getCveId() : "N/A"),
                        vuln.getSeverity().getDisplayName(),
                        vuln.getCvssScore(),
                        escapeCsv(vuln.getRecommendedVersion() != null ? vuln.getRecommendedVersion() : "N/A"),
                        escapeCsv(vuln.getDescription() != null ? vuln.getDescription() : "N/A")
                ));
            }
        }

        return csv.toString().getBytes();
    }

    /**
     * Export vulnerability reports as Excel
     */
    public byte[] exportExcel(List<RepoVulnerabilityReport> reports) throws IOException {
        log.info("Exporting {} vulnerability reports as Excel", reports.size());

        try (Workbook workbook = new XSSFWorkbook(); ByteArrayOutputStream out = new ByteArrayOutputStream()) {
            
            // Create summary sheet
            Sheet summarySheet = workbook.createSheet("Summary");
            createSummarySheet(workbook, summarySheet, reports);

            // Create vulnerabilities sheet
            Sheet vulnSheet = workbook.createSheet("Vulnerabilities");
            createVulnerabilitiesSheet(workbook, vulnSheet, reports);

            // Create statistics sheet
            Sheet statsSheet = workbook.createSheet("Statistics");
            createStatisticsSheet(workbook, statsSheet, reports);

            workbook.write(out);
            return out.toByteArray();
        }
    }

    /**
     * Create summary sheet in Excel
     */
    private void createSummarySheet(Workbook workbook, Sheet sheet, List<RepoVulnerabilityReport> reports) {
        // Create styles
        CellStyle headerStyle = createHeaderStyle(workbook);
        CellStyle criticalStyle = createSeverityStyle(workbook, "FF0000");
        CellStyle highStyle = createSeverityStyle(workbook, "FFA500");
        CellStyle mediumStyle = createSeverityStyle(workbook, "FFFF00");

        // Header row
        Row headerRow = sheet.createRow(0);
        String[] headers = {"Repository", "Total Deps", "Vulnerable", "Safe", "Critical", "High", "Medium", "Low", "Risk Score", "Health Score", "Risk Level"};
        for (int i = 0; i < headers.length; i++) {
            Cell cell = headerRow.createCell(i);
            cell.setCellValue(headers[i]);
            cell.setCellStyle(headerStyle);
        }

        // Data rows
        int rowNum = 1;
        for (RepoVulnerabilityReport report : reports) {
            Row row = sheet.createRow(rowNum++);
            VulnerabilityStatistics stats = report.getStatistics();

            row.createCell(0).setCellValue(report.getRepoName());
            row.createCell(1).setCellValue(stats.getTotalDependencies());
            row.createCell(2).setCellValue(stats.getVulnerableDependencies());
            row.createCell(3).setCellValue(stats.getSafeDependencies());
            
            Cell criticalCell = row.createCell(4);
            criticalCell.setCellValue(stats.getCriticalCount());
            if (stats.getCriticalCount() > 0) criticalCell.setCellStyle(criticalStyle);
            
            Cell highCell = row.createCell(5);
            highCell.setCellValue(stats.getHighCount());
            if (stats.getHighCount() > 0) highCell.setCellStyle(highStyle);
            
            Cell mediumCell = row.createCell(6);
            mediumCell.setCellValue(stats.getMediumCount());
            if (stats.getMediumCount() > 0) mediumCell.setCellStyle(mediumStyle);
            
            row.createCell(7).setCellValue(stats.getLowCount());
            row.createCell(8).setCellValue(report.getRiskScore());
            row.createCell(9).setCellValue(report.getHealthScore());
            row.createCell(10).setCellValue(report.getRiskLevel());
        }

        // Auto-size columns
        for (int i = 0; i < headers.length; i++) {
            sheet.autoSizeColumn(i);
        }
    }

    /**
     * Create vulnerabilities sheet in Excel
     */
    private void createVulnerabilitiesSheet(Workbook workbook, Sheet sheet, List<RepoVulnerabilityReport> reports) {
        CellStyle headerStyle = createHeaderStyle(workbook);

        // Header row
        Row headerRow = sheet.createRow(0);
        String[] headers = {"Repository", "Group ID", "Artifact ID", "Current Version", "Status", "CVE ID", 
                           "Severity", "CVSS Score", "Recommended Version", "Description"};
        for (int i = 0; i < headers.length; i++) {
            Cell cell = headerRow.createCell(i);
            cell.setCellValue(headers[i]);
            cell.setCellStyle(headerStyle);
        }

        // Data rows
        int rowNum = 1;
        for (RepoVulnerabilityReport report : reports) {
            for (DependencyVulnerability vuln : report.getVulnerabilities()) {
                // Only include vulnerable dependencies
                if (vuln.getStatus() != VulnerabilityStatus.VULNERABLE) continue;

                Row row = sheet.createRow(rowNum++);
                row.createCell(0).setCellValue(report.getRepoName());
                row.createCell(1).setCellValue(vuln.getGroupId());
                row.createCell(2).setCellValue(vuln.getArtifactId());
                row.createCell(3).setCellValue(vuln.getCurrentVersion());
                row.createCell(4).setCellValue(vuln.getStatus().getDisplayName());
                row.createCell(5).setCellValue(vuln.getCveId() != null ? vuln.getCveId() : "N/A");
                row.createCell(6).setCellValue(vuln.getSeverity().getDisplayName());
                row.createCell(7).setCellValue(vuln.getCvssScore());
                row.createCell(8).setCellValue(vuln.getRecommendedVersion() != null ? vuln.getRecommendedVersion() : "N/A");
                row.createCell(9).setCellValue(vuln.getDescription() != null ? vuln.getDescription() : "N/A");
            }
        }

        // Auto-size columns
        for (int i = 0; i < headers.length; i++) {
            sheet.autoSizeColumn(i);
        }
    }

    /**
     * Create statistics sheet in Excel
     */
    private void createStatisticsSheet(Workbook workbook, Sheet sheet, List<RepoVulnerabilityReport> reports) {
        CellStyle headerStyle = createHeaderStyle(workbook);

        Row row = sheet.createRow(0);
        Cell cell = row.createCell(0);
        cell.setCellValue("Metric");
        cell.setCellStyle(headerStyle);
        cell = row.createCell(1);
        cell.setCellValue("Value");
        cell.setCellStyle(headerStyle);

        int rowNum = 1;
        
        // Calculate global statistics
        int totalRepos = reports.size();
        int totalDeps = reports.stream().mapToInt(r -> r.getStatistics().getTotalDependencies()).sum();
        int totalVulnerable = reports.stream().mapToInt(r -> r.getStatistics().getVulnerableDependencies()).sum();
        int totalCritical = reports.stream().mapToInt(r -> r.getStatistics().getCriticalCount()).sum();
        int totalHigh = reports.stream().mapToInt(r -> r.getStatistics().getHighCount()).sum();
        int totalMedium = reports.stream().mapToInt(r -> r.getStatistics().getMediumCount()).sum();
        int totalLow = reports.stream().mapToInt(r -> r.getStatistics().getLowCount()).sum();
        double avgRiskScore = reports.stream().mapToDouble(RepoVulnerabilityReport::getRiskScore).average().orElse(0);

        sheet.createRow(rowNum++).createCell(0).setCellValue("Total Repositories");
        sheet.getRow(rowNum - 1).createCell(1).setCellValue(totalRepos);

        sheet.createRow(rowNum++).createCell(0).setCellValue("Total Dependencies");
        sheet.getRow(rowNum - 1).createCell(1).setCellValue(totalDeps);

        sheet.createRow(rowNum++).createCell(0).setCellValue("Vulnerable Dependencies");
        sheet.getRow(rowNum - 1).createCell(1).setCellValue(totalVulnerable);

        sheet.createRow(rowNum++).createCell(0).setCellValue("Critical Vulnerabilities");
        sheet.getRow(rowNum - 1).createCell(1).setCellValue(totalCritical);

        sheet.createRow(rowNum++).createCell(0).setCellValue("High Vulnerabilities");
        sheet.getRow(rowNum - 1).createCell(1).setCellValue(totalHigh);

        sheet.createRow(rowNum++).createCell(0).setCellValue("Medium Vulnerabilities");
        sheet.getRow(rowNum - 1).createCell(1).setCellValue(totalMedium);

        sheet.createRow(rowNum++).createCell(0).setCellValue("Low Vulnerabilities");
        sheet.getRow(rowNum - 1).createCell(1).setCellValue(totalLow);

        sheet.createRow(rowNum++).createCell(0).setCellValue("Average Risk Score");
        sheet.getRow(rowNum - 1).createCell(1).setCellValue(String.format("%.2f", avgRiskScore));

        sheet.autoSizeColumn(0);
        sheet.autoSizeColumn(1);
    }

    /**
     * Export vulnerability reports as JSON
     */
    public byte[] exportJson(List<RepoVulnerabilityReport> reports) throws IOException {
        log.info("Exporting {} vulnerability reports as JSON", reports.size());
        return objectMapper.writerWithDefaultPrettyPrinter()
                .writeValueAsBytes(reports);
    }

    /**
     * Export vulnerability reports as HTML
     */
    public String exportHtml(List<RepoVulnerabilityReport> reports) {
        log.info("Exporting {} vulnerability reports as HTML", reports.size());

        StringBuilder html = new StringBuilder();
        html.append("<!DOCTYPE html>\n");
        html.append("<html>\n<head>\n");
        html.append("<title>Vulnerability Report</title>\n");
        html.append("<style>\n");
        html.append("body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }\n");
        html.append("h1 { color: #333; }\n");
        html.append("h2 { color: #555; margin-top: 30px; }\n");
        html.append(".summary { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }\n");
        html.append(".repo-card { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }\n");
        html.append("table { width: 100%; border-collapse: collapse; margin-top: 10px; }\n");
        html.append("th { background-color: #4CAF50; color: white; padding: 12px; text-align: left; }\n");
        html.append("td { padding: 10px; border-bottom: 1px solid #ddd; }\n");
        html.append(".critical { background-color: #ffebee; color: #c62828; font-weight: bold; }\n");
        html.append(".high { background-color: #fff3e0; color: #e65100; font-weight: bold; }\n");
        html.append(".medium { background-color: #fffde7; color: #f57f17; }\n");
        html.append(".low { background-color: #e8f5e9; color: #2e7d32; }\n");
        html.append(".safe { color: #4CAF50; }\n");
        html.append(".badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; }\n");
        html.append(".risk-score { font-size: 24px; font-weight: bold; }\n");
        html.append(".risk-critical { color: #c62828; }\n");
        html.append(".risk-high { color: #e65100; }\n");
        html.append(".risk-medium { color: #f57f17; }\n");
        html.append(".risk-low { color: #2e7d32; }\n");
        html.append(".risk-safe { color: #4CAF50; }\n");
        html.append("</style>\n</head>\n<body>\n");

        html.append("<h1>üîê Vulnerability Report</h1>\n");
        html.append(String.format("<p>Generated: %s</p>\n", java.time.LocalDateTime.now().format(DATE_FORMATTER)));

        // Global summary
        html.append("<div class='summary'>\n");
        html.append("<h2>Summary</h2>\n");
        int totalRepos = reports.size();
        int totalVulnerable = reports.stream().mapToInt(r -> r.getStatistics().getVulnerableDependencies()).sum();
        int totalCritical = reports.stream().mapToInt(r -> r.getStatistics().getCriticalCount()).sum();
        int totalHigh = reports.stream().mapToInt(r -> r.getStatistics().getHighCount()).sum();
        
        html.append(String.format("<p><strong>Total Repositories:</strong> %d</p>\n", totalRepos));
        html.append(String.format("<p><strong>Vulnerable Dependencies:</strong> %d</p>\n", totalVulnerable));
        html.append(String.format("<p><strong>Critical Issues:</strong> <span class='critical'>%d</span></p>\n", totalCritical));
        html.append(String.format("<p><strong>High Issues:</strong> <span class='high'>%d</span></p>\n", totalHigh));
        html.append("</div>\n");

        // Repository details
        for (RepoVulnerabilityReport report : reports) {
            html.append("<div class='repo-card'>\n");
            html.append(String.format("<h2>%s</h2>\n", report.getRepoName()));
            
            String riskClass = "risk-" + report.getRiskLevel().toLowerCase();
            html.append(String.format("<p class='risk-score %s'>Risk Score: %.1f (%s)</p>\n", 
                    riskClass, report.getRiskScore(), report.getRiskLevel()));
            
            VulnerabilityStatistics stats = report.getStatistics();
            html.append(String.format("<p><strong>Dependencies:</strong> %d total, %d vulnerable, %d safe</p>\n",
                    stats.getTotalDependencies(), stats.getVulnerableDependencies(), stats.getSafeDependencies()));

            // Vulnerability table
            List<DependencyVulnerability> vulnerableOnly = report.getVulnerabilities().stream()
                    .filter(v -> v.getStatus() == VulnerabilityStatus.VULNERABLE)
                    .toList();

            if (!vulnerableOnly.isEmpty()) {
                html.append("<table>\n");
                html.append("<tr><th>Package</th><th>Current</th><th>CVE</th><th>Severity</th><th>CVSS</th><th>Fix Version</th></tr>\n");
                
                for (DependencyVulnerability vuln : vulnerableOnly) {
                    String severityClass = vuln.getSeverity().name().toLowerCase();
                    html.append("<tr>\n");
                    html.append(String.format("<td>%s:%s</td>\n", vuln.getGroupId(), vuln.getArtifactId()));
                    html.append(String.format("<td>%s</td>\n", vuln.getCurrentVersion()));
                    html.append(String.format("<td>%s</td>\n", vuln.getCveId()));
                    html.append(String.format("<td class='%s'>%s</td>\n", severityClass, vuln.getSeverity().getDisplayName()));
                    html.append(String.format("<td>%.1f</td>\n", vuln.getCvssScore()));
                    html.append(String.format("<td>%s</td>\n", vuln.getRecommendedVersion() != null ? vuln.getRecommendedVersion() : "N/A"));
                    html.append("</tr>\n");
                }
                
                html.append("</table>\n");
            } else {
                html.append("<p class='safe'>‚úÖ No vulnerabilities detected</p>\n");
            }

            html.append("</div>\n");
        }

        html.append("</body>\n</html>");
        return html.toString();
    }

    /**
     * Helper: Create header style for Excel
     */
    private CellStyle createHeaderStyle(Workbook workbook) {
        CellStyle style = workbook.createCellStyle();
        Font font = workbook.createFont();
        font.setBold(true);
        font.setColor(IndexedColors.WHITE.getIndex());
        style.setFont(font);
        style.setFillForegroundColor(IndexedColors.DARK_GREEN.getIndex());
        style.setFillPattern(FillPatternType.SOLID_FOREGROUND);
        return style;
    }

    /**
     * Helper: Create severity style for Excel
     */
    private CellStyle createSeverityStyle(Workbook workbook, String hexColor) {
        CellStyle style = workbook.createCellStyle();
        Font font = workbook.createFont();
        font.setBold(true);
        style.setFont(font);
        return style;
    }

    /**
     * Helper: Escape CSV values
     */
    private String escapeCsv(String value) {
        if (value == null) return "";
        return value.replace("\"", "\"\"");
    }
}
