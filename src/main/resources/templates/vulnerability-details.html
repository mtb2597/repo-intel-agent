<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Vulnerability Details - Repo Intelligence Agent</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #f5f7fa;
            font-family: system-ui, Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        .header-section {
            background: #2563eb;
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
            border-radius: 8px;
        }
        .vuln-card {
            border-left: 4px solid;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .vuln-card.critical { border-left-color: #dc3545; }
        .vuln-card.high { border-left-color: #fd7e14; }
        .vuln-card.medium { border-left-color: #ffc107; }
        .vuln-card.low { border-left-color: #17a2b8; }
        .badge-critical { background-color: #dc3545; }
        .badge-high { background-color: #fd7e14; }
        .badge-medium { background-color: #ffc107; color: #000; }
        .badge-low { background-color: #17a2b8; }
        .recommendation-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container" style="max-width: 1400px; margin: 2rem auto; padding: 0 1rem;">
        <div style="margin-bottom:1rem;">
            <a href="/scan" style="color:#2563eb; text-decoration:none; margin-right:1rem;">‚Üê Scan Repos</a>
            <a href="/state" style="color:#2563eb; text-decoration:none; margin-right:1rem;">View State</a>
            <a href="/chat" style="color:#2563eb; text-decoration:none; margin-right:1rem;">Chat</a>
            <a href="/vulnerabilities" style="color:#2563eb; text-decoration:none; font-weight:600;">üõ°Ô∏è Vulnerabilities</a>
        </div>

    <div class="header-section">
        <div style="padding: 0 2rem;">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 style="margin:0; font-size: 2rem;"><i class="fas fa-shield-virus"></i> <span id="repo-name">Repository</span></h1>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.95;">Detailed Vulnerability Analysis</p>
                </div>
                <a href="/vulnerabilities" class="btn btn-light">
                    <i class="fas fa-arrow-left"></i> Back to List
                </a>
            </div>
        </div>
    </div>

        <div id="loading" class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-3">Loading details...</p>
        </div>

        <div id="content" style="display: none;">
            <!-- Summary Cards -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h5>Risk Assessment</h5>
                            <h2 id="risk-score" class="mb-0">0</h2>
                            <p id="risk-level" class="text-muted mb-0">Safe</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h5>Health Score</h5>
                            <h2 id="health-score" class="mb-0">100</h2>
                            <p class="text-muted mb-0">out of 100</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h5>Vulnerabilities</h5>
                            <h2 id="vuln-count" class="mb-0">0</h2>
                            <p id="cve-count" class="text-muted mb-0">0 CVEs</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recommendations -->
            <div id="recommendations"></div>

            <!-- Action Buttons -->
            <div class="mb-4">
                <button class="btn btn-primary" id="fix-button" onclick="generateFix()">
                    <i class="fas fa-tools"></i> Generate Fix Bundle
                </button>
                <button class="btn btn-success" onclick="exportReport()">
                    <i class="fas fa-file-excel"></i> Export Report
                </button>
            </div>

            <!-- Vulnerability List -->
            <h3 class="mb-3">Vulnerabilities</h3>
            <div id="vulnerability-list"></div>

            <!-- All Dependencies -->
            <h3 class="mt-5 mb-3">All Dependencies</h3>
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Package</th>
                        <th>Version</th>
                        <th>Status</th>
                        <th>Age (days)</th>
                    </tr>
                </thead>
                <tbody id="dependency-table"></tbody>
            </table>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentReport = null;
        let repoName = null;

        async function loadDetails() {
            const params = new URLSearchParams(window.location.search);
            repoName = params.get('repo');
            
            if (!repoName) {
                alert('No repository specified');
                window.location.href = '/vulnerabilities.html';
                return;
            }

            document.getElementById('repo-name').textContent = repoName;

            try {
                const response = await fetch(`/api/vulnerabilities/${encodeURIComponent(repoName)}`);
                currentReport = await response.json();
                
                displayDetails(currentReport);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
            } catch (error) {
                console.error('Error loading details:', error);
                document.getElementById('loading').innerHTML = 
                    '<div class="alert alert-danger">Failed to load vulnerability details</div>';
            }
        }

        function displayDetails(report) {
            // Summary
            document.getElementById('risk-score').textContent = report.riskScore.toFixed(1);
            document.getElementById('risk-level').textContent = report.riskLevel + ' Risk';
            document.getElementById('risk-level').className = `text-${getRiskColor(report.riskLevel)}`;
            
            document.getElementById('health-score').textContent = report.healthScore;
            document.getElementById('vuln-count').textContent = report.statistics.vulnerableDependencies;
            document.getElementById('cve-count').textContent = report.statistics.totalCves + ' CVEs';

            // Recommendations
            if (report.recommendations && report.recommendations.length > 0) {
                const recDiv = document.getElementById('recommendations');
                recDiv.innerHTML = `
                    <div class="recommendation-box">
                        <h5><i class="fas fa-lightbulb"></i> Recommendations</h5>
                        <ul class="mb-0">
                            ${report.recommendations.map(r => `<li>${r}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            // Fix button
            document.getElementById('fix-button').style.display = 
                report.fixAvailable ? 'inline-block' : 'none';

            // Vulnerabilities
            const vulnList = document.getElementById('vulnerability-list');
            const vulnerabilities = report.vulnerabilities.filter(v => v.status === 'VULNERABLE');
            
            if (vulnerabilities.length === 0) {
                vulnList.innerHTML = '<p class="text-success"><i class="fas fa-check-circle"></i> No vulnerabilities detected</p>';
            } else {
                vulnList.innerHTML = vulnerabilities.map(v => createVulnCard(v)).join('');
            }

            // All dependencies
            const depTable = document.getElementById('dependency-table');
            depTable.innerHTML = report.vulnerabilities
                .map(v => `
                    <tr class="${v.status === 'VULNERABLE' ? 'table-danger' : ''}">
                        <td><code>${v.groupId}:${v.artifactId}</code></td>
                        <td>${v.currentVersion}</td>
                        <td>
                            <span class="badge bg-${getStatusColor(v.status)}">${v.status}</span>
                            ${v.severity !== 'NONE' ? 
                                `<span class="badge badge-${v.severity.toLowerCase()}">${v.severity}</span>` : ''}
                        </td>
                        <td>${v.daysOld}</td>
                    </tr>
                `).join('');
        }

        function createVulnCard(vuln) {
            return `
                <div class="card vuln-card ${vuln.severity.toLowerCase()}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h5 class="card-title">
                                    ${vuln.cveId || 'Vulnerability'}
                                    <span class="badge badge-${vuln.severity.toLowerCase()}">${vuln.severity}</span>
                                </h5>
                                <h6 class="text-muted">
                                    <code>${vuln.groupId}:${vuln.artifactId}</code>
                                </h6>
                            </div>
                            <div class="text-end">
                                <div class="badge bg-danger">CVSS ${vuln.cvssScore.toFixed(1)}</div>
                            </div>
                        </div>
                        
                        <p class="card-text">${vuln.description || 'No description available'}</p>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <small class="text-muted">Current Version</small>
                                <div><strong>${vuln.currentVersion}</strong></div>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted">Recommended Version</small>
                                <div><strong class="text-success">${vuln.recommendedVersion || 'N/A'}</strong></div>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted">Affected Range</small>
                                <div><code>${vuln.affectedRange || 'N/A'}</code></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getRiskColor(level) {
            const colors = {
                'Critical': 'danger',
                'High': 'warning',
                'Medium': 'info',
                'Low': 'primary',
                'Safe': 'success'
            };
            return colors[level] || 'secondary';
        }

        function getStatusColor(status) {
            return status === 'VULNERABLE' ? 'danger' : 
                   status === 'SAFE' ? 'success' : 'secondary';
        }

        async function generateFix() {
            try {
                const response = await fetch(`/api/vulnerabilities/fix/download/${encodeURIComponent(repoName)}`);
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${repoName}-vulnerability-fix.zip`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            } catch (error) {
                alert('Failed to generate fix: ' + error.message);
            }
        }

        function exportReport() {
            window.open(`/api/vulnerabilities/export/excel`, '_blank');
        }

        document.addEventListener('DOMContentLoaded', loadDetails);
    </script>
    </div> <!-- Close container -->
</body>
</html>
